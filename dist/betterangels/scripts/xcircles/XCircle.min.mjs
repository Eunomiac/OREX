import{gsap as t,Dragger as s,InertiaPlugin as e,MotionPathPlugin as i,U as r,XElem as n,XItem as o,XDie as h,XSnap as c,MIX as a,HasSnapPath as u}from"../helpers/bundler.mjs";export default class l extends(a(n).t(u)){static get i(){return{...super.i,o:"pink",h:"yellow",u:"cyan",l:"purple"}}static get p(){return{...super.p,m:[...super.p.m,"x-circle"],g:"xCircle"}}static S({x:s,y:e}){const i=t._.P({values:Array.from(this.I.keys())},{x:s,y:e}),r=this.I.get(i);return{...i,$:r}}static A(t,s){if(t.P)return[t.P.$,t.P.k];const{x:e,y:i,$:r}=this.S(s);return t.v!==r&&(t.v?.F(t),r.T(t)),[r,{x:e,y:i}]}static C(t){return this.S(t).$}constructor(t,s,e,i={}){super($(`\n    <div style="height: ${2*e}px; width: ${2*e}px;">\n      <svg height="100%" width="100%">\n        <circle cx="${e}" cy="${e}" r="${e}" stroke="none"></circle>\n        <circle class="motion-path" cx="${e}" cy="${e}" r="${.8*e}" fill="none" stroke="none"></circle>\n      </svg>\n    </div>`),{properties:{x:t,y:s},M:{x:.8*e,y:.8*e},W:[`x-circle-${i.type??l.p.q}`],...i}),this.D(!0)}get O(){return this.U=this.U??[]}get j(){const s=new Map;let e=0;this.O.forEach((t=>{e+=t.L,s.set(t,e-.5*t.L)}));for(const[i,r]of s.entries())s.set(i,t._.normalize(0,e,r));return s}get N(){return Array.from(this.j.values())}get R(){return Array.from(this.j.keys())}get X(){return this.Y=this.Y??new Map}G(s){s?[s].flat().forEach((s=>{t.B(this.H,s),"rotation"===s&&delete this.J})):(t.B(this.H),delete this.J)}D(t){}K(t,s){function e(t,s){const e=s.findIndex((s=>t===s));return s[e===s.length-1?0:e+1]}if(t=[...t],s=[...s],t.length!==s.length)return{isEqual:!1,V:!1};if(t.every(((t,e)=>t===s[e])))return{isEqual:!0,V:!0};const i={isEqual:!1,V:!0};for(const r of t)if(e(r,t)!==e(r,s)){i.V=!1;break}return i.V&&(t[0]===s[1]?i.Z=0:t[1]===s[0]&&(i.Z=t.length-1)),i}tt(t){const{N:s}=this,e=s.findIndex(((s,e,i)=>e===i.length-1||s>=t));s.reverse();return[this.j.size-1-s.findIndex(((s,e,i)=>e===i.length-1||s<=t)),e]}st({x:s,y:e}){if([s,e].includes(void 0))return!1;const i=this.et({x:s,y:e});return t._.normalize(-180,180,i)}it({x:s,y:e}){if([s,e].includes(void 0))return!1;this.et({x:s,y:e});const i=this.st({x:s,y:e});if(!1!==i){const[s,e]=this.tt(i);return 0===e||s===e||t._.P([this.N[s],this.N[e]],i)===this.N[e]?e:s}return!1}rt(t){return{...this.nt(this.j.get(t)),slot:this.O.findIndex((s=>s===t))}}ot(t){return[...t??this.O].map((s=>this.rt(s,t).ht))}ct(t){return this.O.find((s=>s.ut===t))}lt(t){return this.rt(this.ct(t))}yt(t,s=this.O){return s.filter((s=>s!==t))}dt(t,s,e=this.O){return s=s??e.length,[...e.slice(0,s),...[t].flat(),...e.slice(s)]}gt(t){const s=c.i[[["die",h]].find((([s,e])=>t instanceof e))[0]],{slot:e}=this.rt(t);if(~e){const i=[...this.O];return i[e]=new c(t,{$:this,type:s,St:t}),i}return!1}ft(t){const{slot:s}=this.lt(t);if(~s){const e=[...this.O];return e[s]=t,e}return!1}async Pt(t,s=1){const e=[...this.O],i=this.K(e,t);if(i.isEqual)return Promise.resolve();i.V&&"Z"in i&&(t=[e[e.length-1],...e.slice(1,-1),e[0]]),this.U=[...t];const r=this.ot(this.O);return Promise.allSettled(this.O.map(((t,s)=>t.xt(r[s]))))}async _t(t,s){const{slot:e}=this.rt(t);return Number.isInteger(s)?e===s?Promise.resolve():this.Pt(this.dt(t,s,this.yt(t))):Promise.reject()}async wt(t,s=!1){if(t.$)return Promise.reject();if(this.ct(t))return Promise.resolve();const e=this.it(s?t.P.k:t),i=new c(t,{$:this});return this.Pt(this.dt(i,e,this.yt(i)))}async It(t){const s=this.ct(t);return s?this.Pt(this.yt(s)).then((()=>s.$t())):Promise.reject()}async At(t=1,s=h.i.kt){const e=[...Array(t)].map((()=>new h({$:this,type:s})));return this.Pt(this.dt(e))}async vt(t){this.Pt(this.yt(t)),t.$t()}async Ft(t){return this.Pt(this.gt(t)).then((()=>this.Tt(t)))}Tt(s){function e(){const t=this.ct(s);t&&this._t(t,this.it(s))}this.X.has(s)||(this.X.set(s,e.bind(this)),t.Et.add(e.bind(this)))}Ct(s){this.X.has(s)&&(t.Et.remove(this.X.get(s)),this.X.delete(s))}async T(t){return this.wt(t).then((()=>this.Tt(t))).catch((()=>console.warn(`Could not open snap point for ${t.name}`)))}async F(t){return this.Ct(t),this.It(t)}async bt(s){if(!s.Mt)return Promise.reject();const{Wt:e,qt:i,Dt:n}=s.Ot;return this.D(!1),this.Ct(s),this.wt(s,!0).then((()=>{const{angle:o}=this.rt(this.ct(s)),h=this.Ut({x:i,y:n}),c=r.jt(o,h),a=e.duration()-e.time(),u=`${c>0?"+":"-"}=${Math.abs(parseInt(c))}`;t.to(this.H,{rotation:u,duration:a,Lt:"power4.out",Nt:this,Rt(){this.items.forEach((t=>t.Xt()))},Yt(){s.$=this,s.Xt(),this.Pt(this.ft(s)),this.D(!0)}})}))}}