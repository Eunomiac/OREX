/* ▌██░░ betterangels v0.0.1-prealpha (2021) ║ MIT License ║ https://github.com/Eunomiac/betterangels ░░██▐ */import gsap,{Draggable as GSDraggable,InertiaPlugin,MotionPathPlugin}from"/scripts/greensock/esm/all.js";gsap.registerPlugin(InertiaPlugin,MotionPathPlugin);const NEARNESSTHRESHOLD=100,{getProperty:getProperty,set:set,utils:{random:getRandom}}=gsap,getCenter=t=>({x:getProperty(t,"x")+.5*getProperty(t,"width"),y:getProperty(t,"y")+.5*getProperty(t,"height")}),setCenter=(t,{x:e,y:i})=>{e-=.5*getProperty(t,"width"),i-=.5*getProperty(t,"height"),set(t,{x:e,y:i})},getDistance=({x1:t,y1:e},{x2:i,y2:s})=>Math.sqrt((t-i)**2+(e-s)**2),getDistanceBetween=(t,e)=>getDistance(getCenter(t),getCenter(e)),getClosest=(t,e,i=[])=>{let s,r;return e.filter((t=>!i.includes(t))).forEach((e=>{const i=getDistanceBetween(t,e);i<(s??1/0)&&(s=i,r=e)})),r},isInside=(t,e)=>t.hitTest(e,"100%"),isNear=(t,e)=>getDistanceBetween(t,e)<100+.5*getProp(e,"width"),[CONTAINER]=$('<div id="roller-container" />').appendTo(".vtt.game.system-betterangels"),[CIRCLES,DICE]=[[],[]];gsap.registerEffect({name:"rotate",defaults:{duration:200},effect:(t,e)=>{gsap.to(t,{rotation:"+=360",duration:e.duration,ease:"none",repeat:-1})}}),gsap.registerEffect({name:"outline",defaults:{size:10,color:"rgba(255, 0, 0, 1)",duration:2},effect:(t,e)=>gsap.to(t,{duration:e.duration,outlineColor:e.color,outlineWidth:e.size})}),gsap.registerEffect({name:"fade",defaults:{opacity:.5,duration:2},effect:(t,e)=>gsap.to(t,{opacity:e.opacity,duration:e.duration})});const setDieStartPos=(t,e,i=.3)=>{const s=.5*(1-i)*getElem(e).width(),{x:r,y:a}=getCenter(e),o=360/t.length;let l=0;t.map((e=>{l+=o;const{left:i,top:c}=getTopLeftPoint({x:s*Math.cos(l*(Math.PI/180))+r,y:s*Math.sin(l*(Math.PI/180))+a,height:getElem(e).height(),width:getElem(e).width()});return gsap.set(getElem(e),{x:i,y:c}),{angle:l,stepSize:o,numDice:t.length,left:i,top:c}}))},CIRCLESTATES={targeted:{size:10,color:"rgba(0, 0, 255, 1)",opacity:.75,duration:.5},invalid:{size:10,color:"rgba(255, 0, 0, 1)",opacity:.1,duration:.5},near:{size:20,color:"rgba(0, 130, 0, 1)",opacity:.75,duration:.5},inside:{size:40,color:"rgba(0, 255, 0, 1)",opacity:1,duration:.5},none:{size:0,color:"rgba(0, 0, 0, 0)",opacity:.5,duration:.5}},changeCircleState=(t,e)=>{if(t){const{size:i,color:s,duration:r,opacity:a}=CIRCLESTATES[e];gsap.effects.outline(t,{size:i,color:s,duration:r}),gsap.effects.fade(t,{opacity:a,duration:r})}},pulseCircle=t=>gsap.effects.pulse(t),createDie=({circle:t,color:e})=>{const i=`die${DICE.length+1}`,[s]=GSDraggable.create($(`<div id="${i}" class="roll-die">${DICE.length+1}</div>`).appendTo(".vtt.game.system-betterangels").css({position:"absolute",background:`radial-gradient(ellipse, #FFFFFF, ${e} 90%)`,height:DICEPARAMS.height,width:DICEPARAMS.width,outline:"3px solid #000000","border-radius":5}),{dragResistance:0,type:"x,y",inertia:!0,snap:{points(t){let e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES);e!==this.startCircle||isInside(this,this.startCircle)||(e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES,this.startCircle));const{x:i,y:s,width:r,height:a}=getPosData(e);return{x:wiggle(i-.5*getProp(this,"width"),r,.6),y:wiggle(s-.5*getProp(this,"height"),a,.6)}}},onDragStart(){const t=getClosestToElem(this.target,CIRCLES);isInside(this,t)&&(this.startCircle=t,changeCircleState(this.startCircle,"inside"))},onDrag(){if(isInside(this,this.startCircle))this.closestCircle!==this.startCircle&&changeCircleState(this.closestCircle,"none"),changeCircleState(this.startCircle,"inside");else{changeCircleState(this.startCircle,"invalid");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&changeCircleState(this.closestCircle,"none"),this.closestCircle=t,isInside(this,this.closestCircle)?changeCircleState(this.closestCircle,"inside"):isNear(this,this.closestCircle)?changeCircleState(this.closestCircle,"near"):changeCircleState(this.closestCircle,"targeted")}},onRelease(){let t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES);t!==this.startCircle||isInside(this,this.startCircle)||(t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES,this.startCircle)),this.targetCircle=t,pulseCircle(this.targetCircle)},onThrowUpdate(){if(isInside(this,this.startCircle))this.closestCircle&&changeCircleState(this.closestCircle,"none"),changeCircleState(this.startCircle,"inside");else{changeCircleState(this.startCircle,"invalid");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&(changeCircleState(this.closestCircle,"none"),this.closestCircle=t),this.closestCircle!==this.startCircle&&(isNear(this.target,this.closestCircle)?changeCircleState(this.closestCircle,"near"):changeCircleState(this.closestCircle,"targeted"))}},onThrowComplete(){changeCircleState(this.startCircle,"none"),changeCircleState(this.closestCircle,"none"),this.startCircle=null,this.closestCircle=null}});return gsap.set(`#${i}`,{transformOrigin:"50% 50%"}),gsap.effects.rotate(s),DICE.push(s),s},createCircle=(t,{r:e,g:i,b:s},{left:r,top:a,height:o,width:l},c={})=>{const n={height:o,width:l,position:"absolute","pointer-events":"none",background:`radial-gradient(ellipse, ${`rgb(${Math.max(e,150)}, ${Math.max(i,150)}, ${Math.max(s,150)})`}, ${`rgb(${e}, ${i}, ${s})`} 70%)`,"border-radius":"50%","text-align":"center","font-size":64,"line-height":"200px","font-weight":"bold",...c},g=`rollCircle${CIRCLES.length+1}`,[h]=$(`<div id="${g}" class="roll-circle">${CIRCLES.length+1}</div>`).appendTo(".vtt.game.system-betterangels").css(n);gsap.set(h,{transformOrigin:"50% 50%",x:r,y:a}),changeCircleState(h,"none"),gsap.effects.rotate(h),CIRCLES.push(h);const C=[];for(let e=0;e<t;e++)C.push(createDie({circle:h,color:"#00FF00"}));setDieStartPos(C,h)},testGrid={x:gsap.utils.distribute({base:CONTAINERPADDING.left,amount:getProp(CONTAINER,"width")-getProp("#sidebar","width")-CONTAINERPADDING.left-CONTAINERPADDING.right,from:"start",grid:[2,3],axis:"x"}),y:gsap.utils.distribute({base:CONTAINERPADDING.top,amount:CONTAINER.get("height")-CONTAINERPADDING.top-CONTAINERPADDING.bottom,from:"start",grid:[2,3],axis:"y"})};export default()=>{[[3,{r:255,g:0,b:255}],[5,{r:0,g:255,b:255}],[7,{r:255,g:0,b:0}],[9,{r:255,g:255,b:0}],[11,{r:0,g:0,b:255}],[13,{r:0,g:255,b:0}]].map(((t,e,i)=>[...t,{left:testGrid.x(e,t,i),top:testGrid.y(e,t,i),height:200,width:200}])).forEach((t=>createCircle(...t)))};