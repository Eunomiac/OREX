/* ▌██░░ betterangels v0.0.1-prealpha (2021) ║ MIT License ║ https://github.com/Eunomiac/betterangels ░░██▐ */import GSDraggable from"/scripts/greensock/esm/Draggable.js";const NEARNESSTHRESHOLD=100,COLORCLASSES=["blue","red","green","grey","no-outline"],CONTAINER=$(".vtt.game.system-betterangels"),CONTAINERPADDING={left:100,top:50,bottom:100,right:$("#sidebar").width()+100},CIRCLES=[],DICE=[],getElem=t=>t instanceof GSDraggable?$(t.target):t instanceof $?t:$(t)[0]instanceof HTMLElement?$(t):[!1],getPosData=t=>{const e=getElem(t);if(e[0]){const t=e.offset(),s={top:t.top,left:t.left,height:e.height(),width:e.width()};return{...s,x:s.left+.5*s.width,y:s.top+.5*s.height}}if(/^\[object Object\]$/.test(String(t))){const e={};return"width"in t&&(e.width=t.width,"x"in t?(e.left=t.x-.5*t.width,e.x=t.x):"left"in t&&(e.left=t.left,e.x=t.left+.5*t.width)),"height"in t&&(e.height=t.height,"y"in t?(e.top=t.y-.5*t.height,e.y=t.y):"top"in t&&(e.top=t.top,e.y=t.top+.5*t.height)),e}throw new Error(`Bad Position Object: ${JSON.stringify(e)}`)},wiggle=(t,e,s=0)=>{const i=.5*s*e;return t+(Math.random()-.5)*(e-2*i)},getDistanceToPoint=({posX:t,posY:e},s)=>{const{x:i,y:o}=getPosData(s);return Math.sqrt((t-i)**2+(e-o)**2)},getDistanceToElem=(t,e)=>{const{x:s,y:i}=getPosData(t);return getDistanceToPoint({posX:s,posY:i},e)},getClosestToPoint=({posX:t,posY:e},s,i=!1)=>{let o,r;return s.forEach((s=>{if(s!==i){const i=getDistanceToPoint({posX:t,posY:e},s);(!o||i<o)&&(o=i,r=s)}})),r},getClosestToElem=(t,e,s=!1)=>{const{x:i,y:o}=getPosData(t);return getClosestToPoint({posX:i,posY:o},e,s)},isInside=(t,e)=>t.hitTest(e,"100%"),isTouching=(t,e)=>t.hitTest(e),isNear=(t,e)=>getDistanceToElem(t,e)<100+.5*$(e).width(),changeCircleColor=(t,e)=>{[t]=getElem(t),t&&e&&(t.newColorClass=e,t.isChangingColor||updateCircleColor(t))},updateCircleColor=t=>{if([t]=getElem(t),t){const[e]=Array.from(t.classList).filter((t=>COLORCLASSES.includes(t)));t.newColorClass=t.newColorClass??"",e===t.newColorClass?t.isChangingColor=!1:(t.isChangingColor=!0,$(t).switchClass(e,t.newColorClass,{duration:300,complete:()=>{t.isChangingColor=!1,updateCircleColor(t)}}))}},pulseCircle=t=>{"pulser"in t&&t.pulser.restart()},createDie=({circle:t,color:e})=>{const s=`die${DICE.length+1}`,[i]=GSDraggable.create($(`<div id="${s}" class="roll-die"/>`).appendTo(".vtt.game.system-betterangels").css({position:"absolute",background:`radial-gradient(ellipse, #FFFFFF, ${e} 90%)`,height:20,width:20,"border-radius":10,border:`3px solid ${e}`}),{dragResistance:0,type:"x,y",inertia:!0,snap:{points(t){let e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES);e!==this.startCircle||isInside(this,this.startCircle)||(e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES,this.startCircle));const{x:s,y:i,width:o,height:r}=getPosData(e);return{x:wiggle(s-.5*$(this.target).width(),o,.6),y:wiggle(i-.5*$(this.target).height(),r,.6)}}},onDragStart(){const t=getClosestToElem(this.target,CIRCLES);isInside(this,t)&&(this.startCircle=t,changeCircleColor(this.startCircle,"green"))},onDrag(){if(isInside(this,this.startCircle))this.closestCircle&&changeCircleColor(this.closestCircle,"no-outline"),changeCircleColor(this.startCircle,"green");else{changeCircleColor(this.startCircle,"red");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&(changeCircleColor(this.closestCircle,"no-outline"),this.closestCircle=t),this.closestCircle!==this.startCircle&&(isNear(this.target,this.closestCircle)?changeCircleColor(this.closestCircle,"green"):changeCircleColor(this.closestCircle,"blue"))}},onRelease(){let t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES);t!==this.startCircle||isInside(this,this.startCircle)||(t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES,this.startCircle)),this.targetCircle=t,pulseCircle(this.targetCircle)},onThrowUpdate(){if(isInside(this,this.startCircle))this.closestCircle&&changeCircleColor(this.closestCircle,"no-outline"),changeCircleColor(this.startCircle,"green");else{changeCircleColor(this.startCircle,"red");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&(changeCircleColor(this.closestCircle,"no-outline"),this.closestCircle=t),this.closestCircle!==this.startCircle&&(isNear(this.target,this.closestCircle)?changeCircleColor(this.closestCircle,"green"):changeCircleColor(this.closestCircle,"blue"))}},onThrowComplete(){changeCircleColor(this.startCircle,"no-outline"),changeCircleColor(this.closestCircle,"no-outline"),this.startCircle=null,this.closestCircle=null}}),{x:o,y:r,height:l,width:c}=getPosData($(t));gsap.set(`#${s}`,{x:wiggle(o-.5*$(i.target).width(),c,.6),y:wiggle(r-.5*$(i.target).height(),l,.6)}),DICE.push(i)},createCircle=(t,e,{left:s,top:i,height:o,width:r},l={})=>{const c={height:o,width:r,position:"absolute","pointer-events":"none",background:`radial-gradient(ellipse, transparent, ${e} 70%)`,"border-radius":"50%",...l},a=`rollCircle${CIRCLES.length+1}`,n=$(`<div id="${a}" class="roll-circle"/>`).appendTo(".vtt.game.system-betterangels").css(c);gsap.set(`#${a}`,{x:s,y:i}),changeCircleColor(n,"no-outline"),n.pulser=gsap.timeline({paused:!0}).to(n,{scale:.5,duration:.25,ease:"power4.out"}).to(n,{scale:2,duration:.25,ease:"power4.out"}).to(n,{scale:1,duration:.5,ease:"sine.out"}),CIRCLES.push(n);for(let e=0;e<t;e++)createDie({circle:n,color:"#00FF00"})};export default()=>{[[6,"#FF00FF",getPosData({top:CONTAINERPADDING.top,left:CONTAINERPADDING.left,height:200,width:200})],[6,"#FFFF00",getPosData({top:CONTAINERPADDING.top,left:CONTAINER.width()-200-CONTAINERPADDING.right,height:200,width:200})],[6,"#00FFFF",getPosData({top:CONTAINER.height()-200-CONTAINERPADDING.bottom,left:(CONTAINER.width()-CONTAINERPADDING.right-100)/2,height:200,width:200})]].forEach((t=>createCircle(...t)))};