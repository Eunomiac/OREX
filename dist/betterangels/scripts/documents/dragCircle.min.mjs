/* ▌██░░ betterangels v0.0.1-prealpha (2021) ║ MIT License ║ https://github.com/Eunomiac/betterangels ░░██▐ */import GSDraggable from"../helpers/Draggable.js";import{CustomWiggle}from"../helpers/CustomWiggle.js";import{CustomEase}from"../helpers/CustomEase.js";gsap.registerPlugin(CustomEase,CustomWiggle);const NEARNESSTHRESHOLD=100,CIRCLESTATES={targeted:{size:10,color:"rgba(0, 0, 255, 1)",opacity:.75,duration:.5},invalid:{size:10,color:"rgba(255, 0, 0, 1)",opacity:.1,duration:.5},near:{size:20,color:"rgba(0, 130, 0, 1)",opacity:.75,duration:.5},inside:{size:40,color:"rgba(0, 255, 0, 1)",opacity:1,duration:.5},none:{size:0,color:"rgba(0, 0, 0, 0)",opacity:.5,duration:.5}},EASECURVES={wiggle:CustomWiggle.create("wiggle",{wiggles:10,type:"random"})},CONTAINER=$(".vtt.game.system-betterangels"),CONTAINERPADDING={left:100,top:50,bottom:100,right:$("#sidebar").width()+100},CIRCLES=[],DICE=[],TIMELINES={},getElem=t=>t instanceof GSDraggable?$(t.target):t instanceof $?t:$(t)[0]instanceof HTMLElement?$(t):[!1],getPosData=t=>{const e=getElem(t);if(e[0]){const t=e.offset(),i={top:t.top,left:t.left,height:e.height(),width:e.width()};return{...i,x:i.left+.5*i.width,y:i.top+.5*i.height}}if(/^\[object Object\]$/.test(String(t))){const e={};return"width"in t&&(e.width=t.width,"x"in t?(e.left=t.x-.5*t.width,e.x=t.x):"left"in t&&(e.left=t.left,e.x=t.left+.5*t.width)),"height"in t&&(e.height=t.height,"y"in t?(e.top=t.y-.5*t.height,e.y=t.y):"top"in t&&(e.top=t.top,e.y=t.top+.5*t.height)),e}throw new Error(`Bad Position Object: ${JSON.stringify(e)}`)},getCenterPoint=t=>{t=getElem(t);const[e,i]=[t.height(),t.width()];return[t]=t,{x:gsap.getProperty(t,"x")+.5*i,y:gsap.getProperty(t,"y")+.5*i}},getTopLeftPoint=({x:t,y:e,height:i,width:s})=>({left:t-.5*s,top:e-.5*i}),wiggle=(t,e,i=0)=>{const s=.5*i*e;return t+(Math.random()-.5)*(e-2*s)},getDistanceToPoint=({posX:t,posY:e},i)=>{const{x:s,y:o}=getPosData(i);return Math.sqrt((t-s)**2+(e-o)**2)},getDistanceToElem=(t,e)=>{const{x:i,y:s}=getPosData(t);return getDistanceToPoint({posX:i,posY:s},e)},getClosestToPoint=({posX:t,posY:e},i,s=!1)=>{let o,r;return i.forEach((i=>{if(i!==s){const s=getDistanceToPoint({posX:t,posY:e},i);(!o||s<o)&&(o=s,r=i)}})),r},getClosestToElem=(t,e,i=!1)=>{const{x:s,y:o}=getPosData(t);return getClosestToPoint({posX:s,posY:o},e,i)},isInside=(t,e)=>t.hitTest(e,"100%"),isTouching=(t,e)=>t.hitTest(e),isNear=(t,e)=>getDistanceToElem(t,e)<100+.5*$(e).width(),setDieStartPos=(t,e,i=.3)=>{const s=.5*(1-i)*getElem(e).width(),{x:o,y:r}=getCenterPoint(e),a=360/(t.length+1);let l=0;t.map((e=>{l+=a;const{left:i,top:n}=getTopLeftPoint({x:s*Math.cos(l*(Math.PI/180))+o,y:s*Math.sin(l*(Math.PI/180))+r,height:getElem(e).height(),width:getElem(e).width()});return gsap.set(getElem(e),{x:i,y:n}),{angle:l,stepSize:a,numDice:t.length,left:i,top:n}}))};gsap.registerEffect({name:"pulse",defaults:{scaleSteps:[.5,2,1],durationSteps:[.25,.25,.5],easeSteps:["power4.out","power4.out","sine.out"]},effect:(t,e)=>gsap.timeline().to(t,{scale:e.scaleSteps[0],duration:e.durationSteps[0],ease:e.easeSteps[0]}).to(t,{scale:e.scaleSteps[1],duration:e.durationSteps[1],ease:e.easeSteps[1]}).to(t,{scale:e.scaleSteps[2],duration:e.durationSteps[2],ease:e.easeSteps[2]})}),gsap.registerEffect({name:"rotate",defaults:{duration:400},effect:(t,e)=>{gsap.to(t,{rotation:"+=360",duration:e.duration,ease:"wiggle",repeat:-1,get startAt(){return{rotation:gsap.utils.random(0,360),scale:gsap.utils.random(.9,1.1),opacity:gsap.utils.random(.25,1)}},yoyo:!0}),gsap.to(t,{keyframes:[{scale:"-=0.1",duration:e.duration/2},{scale:"+=0.2",duration:e.duration/2}],ease:"wiggle",repeat:-1,yoyo:!0}),gsap.to(t,{keyframes:[{opacity:"-=0.25",duration:e.duration/2},{opacity:"+=0.5",duration:e.duration/2}],ease:"wiggle",repeat:-1,yoyo:!0})}}),gsap.registerEffect({name:"outline",defaults:{size:10,color:"rgba(255, 0, 0, 1)",duration:2},effect:(t,e)=>gsap.to(t,{duration:e.duration,outlineColor:e.color,outlineWidth:e.size})}),gsap.registerEffect({name:"fade",defaults:{opacity:.5,duration:2},effect:(t,e)=>gsap.to(t,{opacity:e.opacity,duration:e.duration})});const changeCircleState=(t,e)=>{if(t){const{size:i,color:s,duration:o,opacity:r}=CIRCLESTATES[e];gsap.effects.outline(t,{size:i,color:s,duration:o}),gsap.effects.fade(t,{opacity:r,duration:o})}},pulseCircle=t=>gsap.effects.pulse(t),createDie=({circle:t,color:e})=>{const i=`die${DICE.length+1}`,[s]=GSDraggable.create($(`<div id="${i}" class="roll-die">${DICE.length+1}</div>`).appendTo(".vtt.game.system-betterangels").css({position:"absolute",background:`radial-gradient(ellipse, #FFFFFF, ${e} 90%)`,height:40,width:40,outline:"3px solid black","border-radius":5}),{dragResistance:0,type:"x,y",inertia:!0,snap:{points(t){let e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES);e!==this.startCircle||isInside(this,this.startCircle)||(e=getClosestToPoint({posX:t.x,posY:t.y},CIRCLES,this.startCircle));const{x:i,y:s,width:o,height:r}=getPosData(e);return{x:wiggle(i-.5*$(this.target).width(),o,.6),y:wiggle(s-.5*$(this.target).height(),r,.6)}}},onDragStart(){const t=getClosestToElem(this.target,CIRCLES);isInside(this,t)&&(this.startCircle=t,changeCircleState(this.startCircle,"inside"))},onDrag(){if(isInside(this,this.startCircle))this.closestCircle!==this.startCircle&&changeCircleState(this.closestCircle,"none"),changeCircleState(this.startCircle,"inside");else{changeCircleState(this.startCircle,"invalid");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&changeCircleState(this.closestCircle,"none"),this.closestCircle=t,isInside(this,this.closestCircle)?changeCircleState(this.closestCircle,"inside"):isNear(this,this.closestCircle)?changeCircleState(this.closestCircle,"near"):changeCircleState(this.closestCircle,"targeted")}},onRelease(){let t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES);t!==this.startCircle||isInside(this,this.startCircle)||(t=getClosestToPoint({posX:this.endX,posY:this.endY},CIRCLES,this.startCircle)),this.targetCircle=t,pulseCircle(this.targetCircle)},onThrowUpdate(){if(isInside(this,this.startCircle))this.closestCircle&&changeCircleState(this.closestCircle,"none"),changeCircleState(this.startCircle,"inside");else{changeCircleState(this.startCircle,"invalid");const t=getClosestToElem(this.target,CIRCLES,this.startCircle);t!==this.closestCircle&&(changeCircleState(this.closestCircle,"none"),this.closestCircle=t),this.closestCircle!==this.startCircle&&(isNear(this.target,this.closestCircle)?changeCircleState(this.closestCircle,"near"):changeCircleState(this.closestCircle,"targeted"))}},onThrowComplete(){changeCircleState(this.startCircle,"none"),changeCircleState(this.closestCircle,"none"),this.startCircle=null,this.closestCircle=null}});return gsap.set(`#${i}`,{transformOrigin:"50% 50%"}),gsap.effects.rotate(s),DICE.push(s),s},createCircle=(t,{r:e,g:i,b:s},{left:o,top:r,height:a,width:l},n={})=>{const c={height:a,width:l,position:"absolute","pointer-events":"none",background:`radial-gradient(ellipse, ${`rgb(${Math.max(e,150)}, ${Math.max(i,150)}, ${Math.max(s,150)})`}, ${`rgb(${e}, ${i}, ${s})`} 70%)`,"border-radius":"50%","text-align":"center","font-size":64,"line-height":"200px","font-weight":"bold",...n},g=`rollCircle${CIRCLES.length+1}`,h=$(`<div id="${g}" class="roll-circle">${CIRCLES.length+1}</div>`).appendTo(".vtt.game.system-betterangels").css(c);gsap.set(`#${g}`,{transformOrigin:"50% 50%",x:o,y:r}),changeCircleState(h,"none"),gsap.effects.rotate(h),CIRCLES.push(h);const C=[];for(let e=0;e<t;e++)C.push(createDie({circle:h,color:"#00FF00"}));setDieStartPos(C,h)};export default()=>{[[3,{r:255,g:0,b:255},{top:CONTAINERPADDING.top,left:CONTAINERPADDING.left,height:200,width:200}],[4,{r:255,g:255,b:0},{top:CONTAINERPADDING.top,left:CONTAINER.width()-200-CONTAINERPADDING.right,height:200,width:200}],[5,{r:0,g:255,b:255},{top:CONTAINER.height()-200-CONTAINERPADDING.bottom,left:(CONTAINER.width()-CONTAINERPADDING.right-100)/2,height:200,width:200}]].forEach((t=>createCircle(...t)))};